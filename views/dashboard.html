<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/dashboard.css"> 
    <title>CineBinge - Dashboard</title>
  </head>
  <body class="bg-black text-white dashboard-body">
    <!-- Overlay scuro per migliorare la leggibilità -->
    <div class="fixed inset-0 bg-black bg-opacity-60 -z-10"></div>
    <header class="bg-gradient-to-b from-black to-transparent fixed w-full z-50 top-0 left-0">
      <div class="container mx-auto px-4 py-6 flex justify-between items-center">
        <a href="/">
          <img class="w-32" src="/logo.png" alt="CineBinge" />
        </a>
        <div class="flex gap-4 items-center">
          <a href="/browse" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors text-sm">
            Sfoglia Contenuti
          </a>
          <a id="myRentalsButton" href="/my-rentals" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors text-sm">
            I miei noleggi
          </a>
          <span id="userEmail" class="text-xs text-white hidden md:inline-block"></span>
          <span id="userRole" class="text-xs text-white hidden md:inline-block"></span>
          <button
            onclick="logout()"
            class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors text-sm"
          >
            Logout
          </button>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8 pt-28 relative z-10">
      <div class="max-w-6xl mx-auto">
        <!-- Hero section migliorata -->
        <div class="hero-overlay animate-fade-in">
          <div class="hero-backdrop"></div>
          <div class="hero-content">
            <h1 class="text-4xl md:text-5xl font-bold mb-3 premium-title">Benvenuto su CineBinge</h1>
            <p class="text-xl text-gray-200 mb-6 max-w-2xl">La tua esperienza premium di intrattenimento con contenuti esclusivi e qualità cinematografica</p>
            <div id="subscriptionStatus" class="mb-6"></div>
            <div class="flex flex-wrap gap-4">
              <a href="/browse" class="bg-red-600 text-white px-6 py-3 rounded-full hover:bg-red-700 transition-all hover:shadow-lg hover:shadow-red-600/30 font-semibold flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-film" viewBox="0 0 16 16">
                  <path d="M0 1a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1zm4 0v6h8V1zm8 8H4v6h8zM1 1v2h2V1zm2 3H1v2h2zm-2 3v2h2V7zm2 3H1v2h2zm-2 3v2h2v-2zM15 1h-2v2h2zm-2 3v2h2V4zm2 3h-2v2h2zm-2 3v2h2v-2zm2 3h-2v2h2z"/>
                </svg>
                Sfoglia Catalogo
              </a>
            </div>
          </div>
        </div>
        
        <!-- Contenuto principale -->
        <div class="premium-container p-8 shadow-lg space-y-10 animate-fade-in" style="animation-delay: 0.3s;">
          
          <!-- Sezione Film -->
          <section>
            <div class="flex justify-between items-center mb-5">
              <h2 class="text-2xl font-bold text-white section-title">Film in Evidenza</h2>
              <a href="/browse?type=movie" class="text-red-500 hover:text-red-400 transition-colors text-sm font-medium flex items-center">
                Vedi tutti
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="ml-1">
                  <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
                </svg>
              </a>
            </div>
            <div class="content-container premium-element">
              <button type="button" class="arrow-btn arrow-left" onclick="slide('movies', 'left')">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                  <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/>
                </svg>
              </button>
              
              <!-- Contenitore dei film -->
              <div id="moviesContainer" class="content-slider flex flex-row gap-6 transition-transform duration-500">
                <div class="flex justify-center items-center w-full h-60">
                  <div class="animate-spin rounded-full h-14 w-14 border-t-2 border-b-2 border-red-600"></div>
                </div>
              </div>
              
              <button type="button" class="arrow-btn arrow-right" onclick="slide('movies', 'right')">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                  <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
                </svg>
              </button>
            </div>
          </section>

          <!-- Sezione Serie TV -->
          <section>
            <div class="flex justify-between items-center mb-5">
              <h2 class="text-2xl font-bold text-white section-title">Serie TV Esclusive</h2>
              <a href="/browse?type=series" class="text-red-500 hover:text-red-400 transition-colors text-sm font-medium flex items-center">
                Vedi tutte
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="ml-1">
                  <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
                </svg>
              </a>
            </div>
            <div class="content-container premium-element">
              <button type="button" class="arrow-btn arrow-left" onclick="slide('series', 'left')">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                  <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/>
                </svg>
              </button>
              
              <!-- Contenitore delle serie -->
              <div id="seriesContainer" class="content-slider flex flex-row gap-6 transition-transform duration-500">
                <div class="flex justify-center items-center w-full h-60">
                  <div class="animate-spin rounded-full h-14 w-14 border-t-2 border-b-2 border-red-600"></div>
                </div>
              </div>
              
              <button type="button" class="arrow-btn arrow-right" onclick="slide('series', 'right')">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                  <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
                </svg>
              </button>
            </div>
          </section>
        </div>

        <!-- Sezione per gli admin -->
        <div id="adminSection" style="display: none;" class="premium-container p-8 mt-10 animate-fade-in" style="animation-delay: 0.6s;">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-bold premium-title">Pannello Admin</h2>
            <span class="bg-red-600 text-white px-3 py-1 rounded-full text-xs font-bold">ACCESSO ESCLUSIVO</span>
          </div>
          
          <div class="grid grid-cols-1 gap-6">
            <a href="/manage" class="bg-gradient-to-tr from-zinc-800 to-zinc-700 rounded-xl p-6 hover:shadow-lg hover:shadow-red-600/10 transition-all hover:-translate-y-1 flex flex-col items-center text-center">
              <div class="bg-red-600 p-3 rounded-full mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-film" viewBox="0 0 16 16">
                  <path d="M0 1a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1zm4 0v6h8V1zm8 8H4v6h8zM1 1v2h2V1zm2 3H1v2h2zm-2 3v2h2V7zm2 3H1v2h2zm-2 3v2h2v-2zM15 1h-2v2h2zm-2 3v2h2V4zm2 3h-2v2h2zm-2 3v2h2v-2zm2 3h-2v2h2z"/>
                </svg>
              </div>
              <h3 class="text-lg font-semibold mb-2">Gestisci Contenuti</h3>
              <p class="text-gray-400 text-sm">Aggiungi, modifica o rimuovi film e serie dal catalogo</p>
            </a>
          </div>
        </div>
      </div>
    </main>

    <footer class="bg-gradient-to-t from-black to-gray-800 py-3 mt-auto">
      <div class="container mx-auto text-center">
        <p class="text-gray-400 text-xs">© 2025 CineBinge. Tutti i diritti riservati.</p>
        <div class="flex justify-center space-x-3 mt-2">
          <a href="/about" class="text-xs text-white hover:text-red-500 transition-colors">Chi Siamo</a>
          <a href="/about" class="text-xs text-white hover:text-red-500 transition-colors">Privacy</a>
          <a href="/about" class="text-xs text-white hover:text-red-500 transition-colors">Termini e Condizioni</a>
        </div>
      </div>
    </footer>

    <script>
      // Variabili per gestire lo scorrimento
      const carouselPositions = {
        movies: 0,
        series: 0
      };
      
      const cardWidth = 220; // 200px card + 20px gap
      
      // Funzione per scorrere il carosello
      function slide(section, direction) {
        const container = document.getElementById(`${section}Container`);
        if (!container || container.children.length === 0) {
          return;
        }
        
        const containerParent = container.closest('.content-container');
        const visibleWidth = containerParent.offsetWidth - 120; // Spazio per le frecce
        const scrollAmount = cardWidth * 2; // Scorri di 2 card alla volta
        
        // Calcola la larghezza totale del contenuto
        const totalWidth = container.scrollWidth;
        const maxScroll = Math.max(0, totalWidth - visibleWidth);
        
        // Verifica se ci sono abbastanza elementi per scorrere
        if (totalWidth <= visibleWidth) {
          return;
        }
        
        if (direction === 'right') {
          carouselPositions[section] = Math.min(
            carouselPositions[section] + scrollAmount,
            maxScroll
          );
        } else {
          carouselPositions[section] = Math.max(
            carouselPositions[section] - scrollAmount,
            0
          );
        }
        
        // Applica la trasformazione con bounds checking
        const newPosition = Math.max(0, Math.min(carouselPositions[section], maxScroll));
        carouselPositions[section] = newPosition;
        container.style.transform = `translateX(-${newPosition}px)`;
        
        // Aggiorna la visibilità delle frecce
        updateArrowVisibility(section);
      }
      
      // Funzione per aggiornare la visibilità delle frecce
      function updateArrowVisibility(section) {
        const container = document.getElementById(`${section}Container`);
        const containerParent = container.closest('.content-container');
        
        if (!container || !containerParent) return;
        
        const leftArrow = containerParent.querySelector('.arrow-left');
        const rightArrow = containerParent.querySelector('.arrow-right');
        
        const visibleWidth = containerParent.offsetWidth - 120;
        const totalWidth = container.scrollWidth;
        
        // Nascondi le frecce se non c'è contenuto sufficiente per scorrere
        if (totalWidth <= visibleWidth) {
          if (leftArrow) leftArrow.style.display = 'none';
          if (rightArrow) rightArrow.style.display = 'none';
        } else {
          if (leftArrow) leftArrow.style.display = 'flex';
          if (rightArrow) rightArrow.style.display = 'flex';
          
          // Mostra/nascondi frecce in base alla posizione
          const currentPos = carouselPositions[section] || 0;
          const maxScroll = Math.max(0, totalWidth - visibleWidth);
          
          if (leftArrow) {
            leftArrow.style.opacity = currentPos > 0 ? '1' : '0.5';
          }
          
          if (rightArrow) {
            rightArrow.style.opacity = currentPos < maxScroll ? '1' : '0.5';
          }
        }
      }
      
      // Recupera i dati quando la pagina viene caricata
      document.addEventListener('DOMContentLoaded', () => {
        loadUserInfo();
        loadContent();
        
        // Gestione ridimensionamento finestra
        window.addEventListener('resize', () => {
          // Reset posizioni caroselli
          carouselPositions.movies = 0;
          carouselPositions.series = 0;
          
          // Reset transform
          const moviesContainer = document.getElementById('moviesContainer');
          const seriesContainer = document.getElementById('seriesContainer');
          
          if (moviesContainer) {
            moviesContainer.style.transform = 'translateX(0px)';
            updateArrowVisibility('movies');
          }
          
          if (seriesContainer) {
            seriesContainer.style.transform = 'translateX(0px)';
            updateArrowVisibility('series');
          }
        });
      });
      
      // Funzione per caricare i film e le serie TV
      function loadContent() {
        fetch('/api/movies')
          .then((res) => {
            if (!res.ok) {
              throw new Error(`HTTP error! status: ${res.status}`);
            }
            return res.json();
          })
          .then((movies) => {
            const moviesContainer = document.getElementById('moviesContainer');
            const seriesContainer = document.getElementById('seriesContainer');
            
            // Svuota i contenitori
            moviesContainer.innerHTML = '';
            seriesContainer.innerHTML = '';
            
            // Reset posizioni carosello
            carouselPositions.movies = 0;
            carouselPositions.series = 0;
            
            // Contatori per film e serie
            let movieCount = 0;
            let seriesCount = 0;
            
            // Randomizza l'ordine per variare l'esperienza
            const shuffledMovies = [...movies].sort(() => Math.random() - 0.5);
            
            shuffledMovies.forEach((movie, index) => {
              const contentCard = document.createElement('a');
              contentCard.href = `/movie/${movie.id}`;
              contentCard.className = 'movie-container';
              contentCard.style.setProperty('--animation-order', index);
              
              // Gestione migliorata delle immagini
              const imageUrl = movie.image_path || '/placeholder.jpg';
              const rating = ((Math.random() * 2) + 7).toFixed(1); // Rating casuale tra 7 e 9
              const hasPremiumBadge = Math.random() > 0.3; // 70% di probabilità di avere badge premium
              const hasQualityBadge = Math.random() > 0.4; // 60% di probabilità di avere badge qualità
              const quality = Math.random() > 0.5 ? '4K HDR' : 'HD';
              
              // Generi per categorie
              let categories = '';
              if (movie.genre) {
                const firstGenre = movie.genre.split(',')[0].trim();
                categories = `<span class="category-label">${firstGenre}</span>`;
              }
              
              contentCard.innerHTML = `
                <div class="movie-card">
                  <div class="relative">
                    ${hasQualityBadge ? `<span class="quality-badge">${quality}</span>` : ''}
                    <img src="${imageUrl}" alt="${movie.title}" class="movie-poster" 
                         data-loading="true"
                         onload="this.removeAttribute('data-loading')" 
                         onerror="this.src='/placeholder.jpg'; this.removeAttribute('data-loading')" 
                         loading="lazy">
                  </div>
                  <div class="movie-info">
                    <div class="flex items-center">
                      <h3 class="movie-title">${movie.title}</h3>
                    </div>
                    <div class="flex items-center mb-2">
                      ${categories}
                      <span class="text-gray-400 text-xs ml-1">${movie.release_year || 'N/A'}</span>
                    </div>
                  </div>
                </div>
              `;
              
              // Aggiungi il contenuto alla sezione appropriata
              if (movie.type === 'movie') {
                moviesContainer.appendChild(contentCard);
                movieCount++;
              } else if (movie.type === 'series') {
                seriesContainer.appendChild(contentCard);
                seriesCount++;
              }
            });
            
            // Verifica se ci sono film o serie
            if (movieCount === 0) {
              moviesContainer.innerHTML = `
                <div class="flex justify-center items-center w-full h-60 text-gray-400 animate-fade-in">
                  <div class="text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="currentColor" class="bi bi-film mx-auto mb-4 opacity-50" viewBox="0 0 16 16">
                      <path d="M0 1a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1zm4 0v6h8V1zm8 8H4v6h8zM1 1v2h2V1zm2 3H1v2h2zm-2 3v2h2V7zm2 3H1v2h2zm-2 3v2h2v-2zM15 1h-2v2h2zm-2 3v2h2V4zm2 3h-2v2h2zm-2 3v2h2v-2zm2 3h-2v2h2z"/>
                    </svg>
                    <p>Nessun film disponibile</p>
                    <button class="mt-4 text-red-500 border border-red-500 rounded-full px-4 py-1 text-sm hover:bg-red-500 hover:text-white transition-colors">
                      Aggiungi film
                    </button>
                  </div>
                </div>
              `;
            }
            
            if (seriesCount === 0) {
              seriesContainer.innerHTML = `
                <div class="flex justify-center items-center w-full h-60 text-gray-400 animate-fade-in">
                  <div class="text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="currentColor" class="bi bi-collection-play mx-auto mb-4 opacity-50" viewBox="0 0 16 16">
                      <path d="M2 3a.5.5 0 0 0 .5.5h11a.5.5 0 0 0 0-1h-11A.5.5 0 0 0 2 3zm2-2a.5.5 0 0 0 .5.5h7a.5.5 0 0 0 0-1h-7A.5.5 0 0 0 4 1zm2.765 5.576A.5.5 0 0 0 6 7v5a.5.5 0 0 0 .765.424l4-2.5a.5.5 0 0 0 0-.848l-4-2.5z"/>
                      <path d="M1.5 14.5A1.5 1.5 0 0 1 0 13V6a1.5 1.5 0 0 1 1.5-1.5h13A1.5 1.5 0 0 1 16 6v7a1.5 1.5 0 0 1-1.5 1.5h-13zm13-1a.5.5 0 0 0 .5-.5V6a.5.5 0 0 0-.5-.5h-13A.5.5 0 0 0 1 6v7a.5.5 0 0 0 .5.5h13z"/>
                    </svg>
                    <p>Nessuna serie TV disponibile</p>
                    <button class="mt-4 text-red-500 border border-red-500 rounded-full px-4 py-1 text-sm hover:bg-red-500 hover:text-white transition-colors">
                      Aggiungi serie
                    </button>
                  </div>
                </div>
              `;
            }
            
            // Reset transform dopo il caricamento e verifica visibilità frecce
            setTimeout(() => {
              moviesContainer.style.transform = 'translateX(0px)';
              seriesContainer.style.transform = 'translateX(0px)';
              
              // Verifica se le frecce devono essere visibili
              updateArrowVisibility('movies');
              updateArrowVisibility('series');
              
              // Aggiungi effetti di stile per ogni card
              const allMovieCards = document.querySelectorAll('.movie-card');
              allMovieCards.forEach((card, index) => {
                // Aggiungi effetto delayato per dare sensazione di caricamento progressivo
                setTimeout(() => {
                  card.classList.add('animate-fade-in');
                }, 100 * index);
              });
            }, 100);
          })
          .catch((err) => {
            document.getElementById('moviesContainer').innerHTML = `
              <div class="flex justify-center items-center w-full h-60 text-red-500 animate-fade-in">
                <div class="text-center">
                  <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="currentColor" class="bi bi-exclamation-circle mx-auto mb-4" viewBox="0 0 16 16">
                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                    <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z"/>
                  </svg>
                  <p>Errore nel caricamento dei contenuti</p>
                  <button onclick="loadContent()" class="mt-4 text-red-500 border border-red-500 rounded-full px-4 py-1 text-sm hover:bg-red-500 hover:text-white transition-colors">
                    Riprova
                  </button>
                </div>
              </div>
            `;
            document.getElementById('seriesContainer').innerHTML = document.getElementById('moviesContainer').innerHTML;
          });
      }
      
      // Funzione per caricare le informazioni dell'utente
      function loadUserInfo() {
        const myRentalsButton = document.getElementById('myRentalsButton');
        const subscriptionStatus = document.getElementById('subscriptionStatus');
        
        fetch('/api/user')
          .then((res) => res.json())
          .then((user) => {
            document.getElementById('userEmail').textContent = `${user.email}`;
            document.getElementById('userRole').textContent = user.role === 'admin' ? 'Admin' : 'Utente';
            
            if (user.role === 'admin') {
              document.getElementById('adminSection').style.display = 'block';
            }
            
            // Visualizza lo stato dell'abbonamento
            const subscription = user.subscription || 'basic';
            const isPremium = subscription === 'premium' || subscription === 'Premium';
            
            if (isPremium) {
              subscriptionStatus.innerHTML = `
                <div class="subscription-status subscription-premium inline-flex items-center">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16" class="mr-2">
                    <path d="M2.5 13.5A.5.5 0 0 1 3 13h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4A.5.5 0 0 1 3 9h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4A.5.5 0 0 1 3 5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
                    <path d="M3.854 2.146a.5.5 0 0 1 0 .708l-1.5 1.5a.5.5 0 0 1-.708 0l-.5-.5a.5.5 0 1 1 .708-.708L2 3.293l1.146-1.147a.5.5 0 0 1 .708 0zm0 4a.5.5 0 0 1 0 .708l-1.5 1.5a.5.5 0 0 1-.708 0l-.5-.5a.5.5 0 1 1 .708-.708L2 7.293l1.146-1.147a.5.5 0 0 1 .708 0zm0 4a.5.5 0 0 1 0 .708l-1.5 1.5a.5.5 0 0 1-.708 0l-.5-.5a.5.5 0 0 1 .708-.708l.146.147 1.146-1.147a.5.5 0 0 1 .708 0z"/>
                  </svg>
                  Abbonamento Premium Attivo
                </div>
              `;
              
              // Nascondi "I miei noleggi" per utenti premium (hanno accesso a tutto)
              if (myRentalsButton) {
                myRentalsButton.style.display = 'none';
              }
              
              // Badge premium disabilitati
              
            } else {
              subscriptionStatus.innerHTML = `
                <div class="subscription-status subscription-basic inline-flex items-center">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16" class="mr-2">
                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                    <path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/>
                  </svg>
                  Abbonamento Base
                </div>
              `;
              
              // Mostra "I miei noleggi" per utenti base
              if (myRentalsButton) {
                myRentalsButton.style.display = 'inline-block';
              }
            }
          })
          .catch((err) => {
            console.error('Errore nel caricamento delle informazioni utente:', err);
            
            // Fallback per mostrare comunque qualcosa
            if (subscriptionStatus) {
              subscriptionStatus.innerHTML = `
                <div class="subscription-status subscription-basic inline-flex items-center">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16" class="mr-2">
                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                    <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z"/>
                  </svg>
                  Stato abbonamento non disponibile
                </div>
              `;
            }
          });
      }

      // Funzione di logout
      function logout() {
        performLogout();
      }
      
      // Aggiungi navigazione con tastiera per le sezioni
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') {
          const activeSection = document.activeElement.closest('section');
          if (activeSection) {
            const sectionId = activeSection.querySelector('.content-slider').id.replace('Container', '');
            slide(sectionId, 'left');
          }
        } else if (e.key === 'ArrowRight') {
          const activeSection = document.activeElement.closest('section');
          if (activeSection) {
            const sectionId = activeSection.querySelector('.content-slider').id.replace('Container', '');
            slide(sectionId, 'right');
          }
        }
      });


      // Verifica immediata dell'autenticazione
      document.addEventListener('DOMContentLoaded', function() {
        // Verifica sessione all'avvio della pagina
        checkAuthStatus();
      });

      // Controlla se l'utente è autenticato
      function checkAuthStatus() {
        fetch('/api/user')
          .then(response => {
            if (!response.ok) {
              // Se la risposta non è ok, l'utente non è autenticato
              redirectToLogin();
              throw new Error('Non autenticato');
            }
            return response.json();
          })
          .catch(error => {
            console.error('Errore verifica autenticazione:', error);
            redirectToLogin();
          });
      }

      // Reindirizza alla pagina di login
      function redirectToLogin() {
        window.location.replace('/login');
      }

      // Debug: Controllo per elementi che bloccano l'interazione
      document.addEventListener('DOMContentLoaded', function() {
        // Debug: Verifica elementi con z-index alto
        setTimeout(() => {
          const elements = document.querySelectorAll('*');
          const highZIndexElements = [];
          
          elements.forEach(el => {
            const style = window.getComputedStyle(el);
            const zIndex = parseInt(style.zIndex);
            if (zIndex > 40) {
              highZIndexElements.push({
                element: el,
                zIndex: zIndex,
                pointerEvents: style.pointerEvents
              });
            }
          });
          
          if (highZIndexElements.length > 0) {
           
          }
          
          // Verifica se ci sono overlay invisibili
          const overlays = document.querySelectorAll('[class*="overlay"], [class*="modal"], .fixed');
          overlays.forEach(overlay => {
            const style = window.getComputedStyle(overlay);
            if (style.position === 'fixed' && style.pointerEvents !== 'none') {
              // Overlay blocking element detected
            }
          });
        }, 1000);
      });
      
      // Forza la rimozione di overlay bloccanti
document.addEventListener('DOMContentLoaded', function() {
  // Rimuovi qualsiasi overlay o modal che potrebbe bloccare
  setTimeout(() => {
    // Rimuovi modali di pagamento esistenti
    const existingModals = document.querySelectorAll('#paymentModal');
    existingModals.forEach(modal => modal.remove());
    
    // Verifica e rimuovi overlay problematici
    const problematicOverlays = document.querySelectorAll('.fixed.inset-0:not(header):not(.-z-10)');
    problematicOverlays.forEach(overlay => {
      const style = window.getComputedStyle(overlay);
      if (style.backgroundColor.includes('rgb') && style.pointerEvents !== 'none') {
        overlay.remove();
      }
    });
  }, 500);
});
    </script>
    
    <!-- Script per la gestione dell'autenticazione e logout -->
    <script src="/js/auth-utils.js"></script>
  </body>
</html>